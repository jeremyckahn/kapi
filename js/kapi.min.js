/**
 * Kapi - A keyframe API
 * v1.0.0b2
 * by Jeremy Kahn - jeremyckahn@gmail.com
 * hosted at: https://github.com/jeremyckahn/kapi
 * 
 * Kapi streamlines animation development for the HTML 5 canvas by providing a keyframing API.  It manages timing and tweening so you don't have to.   
 * 
 * Kapi is distributed under the MIT license.
 * Learn more about keyframes: http://en.wikipedia.org/wiki/Key_frame
 * 
 * Please use, distribute and enjoy.
 */

function kapi(w,x,y){function n(a,b,d){var e;if(!b)return a;a=a||{};for(e in b)if(b.hasOwnProperty(e))if(typeof b[e]==="object"&&e!=="prototype"){if(!a[e]||d)a[e]=O.call(b[e])==="[object Array]"?[]:{};n(a[e],b[e],d)}else if(typeof a[e]==="undefined"||d)a[e]=b[e];return n(a,void 0,d)}function D(c,b,d,e,f,j){if((j||a._currentFrame)>=b)return kapi.tween[c]((j||a._currentFrame)-b,e,f-e,d-b||1)}function m(a){return a.length>0?a[a.length-1]:void 0}function E(c){this[c]=this.style[c].replace(/px/gi,"")||
a._params[c]}function F(a){return a.sort(function(a,c){return a-c})}function z(a){return typeof a==="string"&&(/^#([0-9]|[a-f]){3}$/i.test(a)||/^#([0-9]|[a-f]){6}$/i.test(a))}function u(a){return typeof a==="string"&&/^rgb\(\d+\s*,\d+\s*,\d+\s*\)\s*$/i.test(a)}function A(a){return parseInt(a,16)}function G(a){return typeof a==="string"?(a=a.replace(/#/g,""),a.length===3&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),[A(a.substr(0,2)),A(a.substr(2,2)),A(a.substr(4,2))]):[0,0,0]}function H(a){if(typeof a!=="string")return a;
return/^(#|rgb)/.test(a)?/^#/.test(a)?G(a):(a=a.match(/\d+/g),[+a[0],+a[1],+a[2]]):a}function t(a){return typeof a==="string"&&/^\s*(\+|\-|\*|\/)\=\d+\s*$/.test(a)||typeof a==="function"}function r(a){var b;if(typeof a==="number")return parseInt(a,10);else if(typeof a==="string"){a=a.replace(/\s/g,"");b=/^(\d|\.)+/.exec(a)[0];a=/\D+$/.exec(a);if(!a)return parseInt(b,10);if(I[a])b=parseInt(I[a].call(this,b),10);else throw"Invalid keyframe identifier unit!";return b}else throw"Invalid keyframe identifier type!";
}function J(){var c;for(c=0;c<a._layerIndex.length;c++)a._actors[a._layerIndex[c]].params.layer=c}function B(){a._lastKeyframe=m(a._keyframeIds);a._animationDuration=1E3*(a._lastKeyframe/a._params.fRate)}function q(c){var b;if(a._currentFrame===0)return 0;if(a._currentFrame>c[c.length-1])return-1;for(b=c.length-1;b>=0;b--)if(c[b]<a._currentFrame)return b;return c.length-1}function P(c){c.keyframe=function(b,d){var e,f;for(e in d)if(d.hasOwnProperty(e)&&typeof d[e]==="string"&&d[e]===(f=+d[e].replace(/\D/gi,
"")).toString())d[e]=f;e=n({},d);try{b=r(b)}catch(j){window.console&&window.console.error&&console.error(j);return}if(b<0)throw"Keyframe "+b+" is less than zero!";b>0&&typeof a._keyframes["0"]==="undefined"&&(a._keyframes["0"]={},a._keyframeIds.unshift(0));typeof a._keyframes[b]==="undefined"&&(a._keyframes[b]={});typeof a._originalStates[b]==="undefined"&&(a._originalStates[b]={});a._keyframes[b][c.id]=d;a._originalStates[b][c.id]=e;e=b;a:{for(f=0;f<a._keyframeIds.length;f++)if(a._keyframeIds[f]===
e)break a;a._keyframeIds.push(e);F(a._keyframeIds)}e={add:e};f=a._actorstateIndex[c.id];var l=!1,i;if(typeof e.add!=="undefined"){for(i=0;i<f.length;i++)f[i]===e.add&&(l=!0);l||(f.push(e.add),F(f))}e=c.id;var g,h,k,o,p;for(l=0;l<a._actorstateIndex[e].length;l++){f=a._actorstateIndex[e][l];g=typeof g==="undefined"?n({},a._actors[e].params):n({},h);i=n(g,a._originalStates[f][e],!0);i.prototype=a._actors[e];a._keyframes[f][e]=i;for(k in i)if(i.hasOwnProperty(k)&&typeof i[k]==="string")if(h&&(p=h[k]),
o=i[k].replace(/\s/g,""),z(o)||u(o)){g=i;var Q=k;var m=void 0;u(o)||(m=G(o),o="rgb("+m[0]+","+m[1]+","+m[2]+")");g[Q]=o}else h&&p&&t(p)&&typeof a._originalStates[f][e][k]==="undefined"&&(i[k]="+=0");g=f;h=i}var q,s;for(s in a._liveCopies)if(a._liveCopies.hasOwnProperty(s))for(q in h=a._liveCopies[s],h)h.hasOwnProperty(q)&&(a._keyframes[q][s]=a._keyframes[a._liveCopies[s][q].copyOf][s]);J();delete d.layer;B();return this};c.to=function(b,d,e){var f=a._actorstateIndex[c.id].queue;f.push({duration:r(b),
state:d||{},events:e||{}});b=m(f);b._internals={};b._internals.startTime=null;b._internals.fromState=null;b._internals.toState=null;b._internals.pauseBuffer=null;b._internals.pauseBufferUpdated=null;return this};c.clearQueue=function(){a._actorstateIndex[c.id].queue.length=1;return this};c.skipToEnd=function(){var b=a._actorstateIndex[c.id].queue;if(!b.length)return this;b[0]._internals.forceStop=!0;return this};c.endCurrentAction=function(){var b=a._actorstateIndex[c.id].queue;if(!b.length)return this;
b[0]._internals.toState=this.getState();this.skipToEnd();return this};c.remove=function(b){var d,e,f,j=!1;b=r(b);if(a._keyframes[b]&&a._keyframes[b][c.id]){delete a._keyframes[b][c.id];delete a._originalStates[b][c.id];for(d in a._keyframes[b])a._keyframes[b].hasOwnProperty(d)&&(j=!0);if(!j&&b!==0){delete a._keyframes[b];delete a._originalStates[b];for(d=0;d<a._keyframeIds.length;d++)if(a._keyframeIds[d]===b){a._keyframeIds.splice(d,1);break}for(d=0;d<a._reachedKeyframes.length;d++)if(a._reachedKeyframes[d]===
b){a._reachedKeyframes.splice(d,1);break}}for(d=0;d<a._actorstateIndex[c.id].length;d++)if(a._actorstateIndex[c.id][d]===b){a._actorstateIndex[c.id].splice(d,1);d<=a._actorstateIndex[c.id].reachedKeyframes.length&&a._actorstateIndex[c.id].reachedKeyframes.pop();break}a._liveCopies[c.id]&&a._liveCopies[c.id].hasOwnProperty(b)&&delete a._liveCopies[c.id][b];for(e in a._liveCopies[c.id])a._liveCopies[c.id].hasOwnProperty(e)&&a._liveCopies[c.id][e].copyOf===b&&(c.remove(e),f=!0);f||delete a._liveCopies[c.id];
B()}else console&&console.error&&(a._keyframes[b]?console.error("Trying to remove "+c.id+" from keyframe "+b+", but "+c.id+" does not exist at that keyframe."):console.error("Trying to remove "+c.id+" from keyframe "+b+", but keyframe "+b+" does not exist."));return this};c.removeAll=function(){for(var b=c.id;a._actorstateIndex[b]&&a._actorstateIndex[b].length;)a._actors[b].remove(m(a._actorstateIndex[b]));return this};c.updateKeyframe=function(b,d){var e;b=r(b);a._keyframes[b]&&a._keyframes[b][c.id]?
(e=a._originalStates[b][c.id],n(e,d,!0),c.keyframe(b,e)):window.console&&window.console.error&&(a._keyframes[b]?console.error("Keyframe "+b+" does not contain "+c.id):console.error("Keyframe "+b+" does not exist."));return this};c.liveCopy=function(b,d){b=r(b);d=r(d);a._keyframes[d]&&a._keyframes[d][c.id]?(a._liveCopies[c.id][b]={copyOf:d},c.keyframe(b,{})):window.console&&window.console.error&&(a._keyframes[d]?console.error("Trying to make a liveCopy of "+d+", but  "+c.id+" does not exist at keyframe "+
b+"."):console.error("Trying to make a liveCopy of "+d+", but keyframe "+d+" does not exist."));return this};c.getState=function(){return a._currentState[c.id]||{}};c.get=function(b){return b.toLowerCase()==="layer"?a._actors[c.id].params.layer:c.getState()[b]};c.moveToLayer=function(b){var d;if(typeof b!=="number")throw"moveToLayer requires a number specifying which layer to move "+this.id+" to.";b=parseInt(b,10);if(b>-1&&b<a._layerIndex.length)d=a._layerIndex.splice(c.params.layer,1)[0],a._layerIndex.splice(b,
0,d),J();else throw'"'+b+'" is out of bounds.  There are only '+a._layerIndex.length+" layers in the animation, "+c.id+" can only be moved to layers 0-"+a._layerIndex.length;return c};return c}function v(c){var b;if(typeof c==="string"&&a._events[c])for(b=0;b<a._events[c].length;b++)a._events[c][b].call(a)}function K(c,b,d,e,f,j){var l,i,g,h,k,o,p,m={};f=kapi.tween[f]?f:"linear";j=j||{};for(i in c)if(c.hasOwnProperty(i)){g=c[i];h=c.prototype.id;if(typeof g==="object"&&i!=="prototype")for(p in g)if(g.hasOwnProperty(p)){g=
g[p];break}typeof a._keyframeCache[h].from[i]!=="undefined"?g=a._keyframeCache[h].from[i]:t(g)&&(typeof g==="function"?g=g.call(c)||0:(l=g.match(/(\+|\-|\*|\/)\=/)[0],k=q(a._actorstateIndex[h])-1,k=k===-1?c.prototype.params[i]||0:a._keyframes[k][h][i],g=L[l](k,+g.replace(/\D/g,""))),a._keyframeCache[h].from[i]=g);if(typeof g==="number"||t(g)||z(g)||u(g)){k=!1;h=b[i];o=b.prototype.id;if(typeof h==="object"&&i!=="prototype")for(p in h)if(h.hasOwnProperty(p)){f=kapi.tween[p]?p:"linear";h=h[p];break}typeof a._keyframeCache[o].to[i]!==
"undefined"?h=a._keyframeCache[o].to[i]:t(h)&&(typeof h==="function"?h=h.call(b)||0:(l=h.match(/(\+|\-|\*|\/)\=/)[0],h=L[l](g,+h.replace(/\D/g,""))),a._keyframeCache[o].to[i]=h);l=typeof g;if(!(typeof h==="number"||t(h)||z(h)||u(h))||l!==typeof h)m[i]=g;else if(typeof g==="string"&&(k=!0,g=H(g),h=H(h)),k){m[i]="rgb(";for(l=0;l<g.length;l++)m[i]+=Math.floor(D.call(this,f,d,e,g[l],h[l],j.currentFrame))+",";m[i]=m[i].replace(/,$/,")")}else m[i]=D.call(this,f,d,e,g,h,j.currentFrame)}}n(m,c);return m}
function M(c){var b,d,e,f,j,l,i;for(i=0;i<a._layerIndex.length;i++){b=a._layerIndex[i];if(typeof a._actorstateIndex[b][0]!=="undefined"&&c>=a._actorstateIndex[b][0]){d=b;f=a._actorstateIndex[d];j=q(f);var g=l=e=void 0,h=void 0;if(j===-1)d=null;else if(e=j===f.length-1?j:j+1,l=a._keyframes[f[j]][d],g=a._keyframes[f[e]][d],j===e&&a._lastKeyframe>0)d=null;else{h=m(a._actorstateIndex[d].reachedKeyframes)||0;if(!a._keyframeCache[d])a._keyframeCache[d]={from:{},to:{}},a._actorstateIndex[d].reachedKeyframes=
[];j!==h&&j>h&&(a._actorstateIndex[d].reachedKeyframes.push(j),a._keyframeCache[d]={from:a._keyframeCache[d].to,to:{}});d=K(l,g,f[j],f[e],g.easing)}if(d!==null){f=a._actorstateIndex[b].queue;if((j=f.length)>0){l=f[0];e=l.events;typeof e.start==="function"&&(e.start.call(a._actors[b]),delete e.start);if(l._internals.fromState===null)l._internals.fromState=d;e=f;l=b;g=+new Date;h=e[0];var k=h._internals,o=void 0;if(k.startTime===null)k.startTime=g;if(!k.pauseBufferUpdated)k.pauseBufferUpdated=g;if(k.pauseBufferUpdated<
a._pausedAtTime)k.pauseBuffer+=g-a._pausedAtTime,k.pauseBufferUpdated=g;if(k.toState===null)k.toState={},n(k.toState,k.fromState),n(k.toState,h.state,!0);k.currFrame=k.forceStop?h.duration+1:(g-(k.startTime+k.pauseBuffer))/1E3*a._params.fRate;if(k.currFrame>h.duration)o=h.events.complete,typeof o==="function"&&o.call(a._actors[l]),e.shift();e=K(k.fromState,k.toState,0,+h.duration,h.easing||k.fromState.easing,{currentFrame:k.currFrame});n(d,e,!0);j!==f.length&&(f=q(a._actorstateIndex[b]),a._keyframes[a._keyframeIds[f]][b]=
d)}d.prototype.draw.call(d,a.ctx)}}a._currentState[b]=d}}function N(){var c=+new Date;a.fCount++;a._updateHandle=setTimeout(function(){var b;a._loopLength=c-a._loopStartTime;if(a._loopLength>a._animationDuration&&a._reachedKeyframes.length===a._keyframeIds.length){a._loopStartTime=a._startTime+parseInt((c-a._startTime)/(a._animationDuration||1),10)*a._animationDuration;a._loopLength-=a._animationDuration||a._loopLength;a._reachedKeyframes=[];a._keyframeCache={};v("loopComplete");if(a._repsRemaining>
-1&&(a._repsRemaining--,a._repsRemaining===0)){C.stop();if(typeof a._repeatCompleteHandler==="function")a._repeatCompleteHandler.call(a),a._repeatCompleteHandler=void 0;a._repsRemaining=-1;return}v("loopStart")}a._loopPosition=a._animationDuration?a._loopLength/a._animationDuration:0;a._currentFrame=parseInt(a._loopPosition*a._lastKeyframe,10);b=q(a._keyframeIds);b=b===-1?a._lastKeyframe:a._keyframeIds[b];b>(m(a._reachedKeyframes)||0)&&a._reachedKeyframes.push(b);b=a._reachedKeyframes.length?a._reachedKeyframes.length-
1:0;if(a._reachedKeyframes[b]!==a._keyframeIds[b])a._currentFrame=a._reachedKeyframes[b]=a._keyframeIds[b];a._currentFrame<=a._lastKeyframe&&(a.autoclear!==!1&&a.ctx.clearRect(0,0,a.el.width,a.el.height),v("enterFrame"),M(a._currentFrame));N()},1E3/a._params.fRate);return a._updateHandle}var R={fRate:20,autoclear:!0},C={},a={_events:{},_keyframeIds:[],_reachedKeyframes:[],_layerIndex:[],_keyframes:{},_actors:{},_actorstateIndex:{},_keyframeCache:{},_originalStates:{},_liveCopies:{},_currentState:{},
_animationDuration:0,_repsRemaining:-1,_lastKeyframe:void 0,_currentFrame:void 0,_loopStartTime:void 0,_startTime:void 0,_pausedAtTime:void 0,_isPaused:void 0,_isStopped:void 0,_loopLength:void 0,_loopPosition:void 0,_updateHandle:void 0,_repeatCompleteHandler:void 0,fCount:0},O=Object.prototype.toString,I={ms:function(c){return c*a._params.fRate/1E3},s:function(c){return c*a._params.fRate}},L={"+=":function(a,b){return a+b},"-=":function(a,b){return a-b},"*=":function(a,b){return a*b},"/=":function(a,
b){return a/b}};C={init:function(c,b,d){var e,f;b=b||{};d=d||{};n(b,R);a._params=b;a.autoclear=!!a._params.autoclear;a._params.canvas=c;a.el=c;a.ctx=c.getContext("2d");for(f in d)d.hasOwnProperty(f)&&this.bind(f,d[f]);for(e in a._params.styles)if(a._params.styles.hasOwnProperty(e)){a._params.styles[e]=a._params.styles[e].toString().toLowerCase();if(e==="height"||e==="width"||e==="top"||e==="left")a._params.styles[e].match(/px/)||(a._params.styles[e]+="px");c=a.el.style;b=e;d=a._params.styles[e];typeof d===
"string"&&(d=d.replace(/\s/g,""));c[b]=d}a._params.styles&&(a._params.styles.height&&E.call(a.el,"height"),a._params.styles.width&&E.call(a.el,"width"));delete this.init;return this},getVersion:function(){return"1.0.0b"},isPlaying:function(){return a._isStopped===!1&&a._isPaused===!1},play:function(){var c;c=+new Date;if(this.isPlaying())return this;a._isStopped=a._isPaused=!1;if(!a._startTime)a._startTime=c;a._loopStartTime?(c-=a._pausedAtTime,a._loopStartTime+=c,a._startTime+=c):(a._loopStartTime=
c,B(),v("loopStart"));N();return this},pause:function(){clearTimeout(a._updateHandle);a._pausedAtTime=+new Date;a._isPaused=!0;return this},stop:function(){var c;clearTimeout(a._updateHandle);delete a._loopStartTime;delete a._startTime;delete a._pausedAtTime;a._isStopped=!0;a._repsRemaining=-1;for(c in a._actorstateIndex)if(a._actorstateIndex.hasOwnProperty(c))a._actorstateIndex[c].queue=[],a._actorstateIndex[c].reachedKeyframes=[];a.ctx.clearRect(0,0,a.el.width,a.el.height);return this},repeat:function(c,
b){typeof c==="number"&&c>=-1?(a._repeatCompleteHandler=b,a._repsRemaining=parseInt(c,10)+1):a._repsRemaining=-1;return this.play()},iterate:function(a,b){typeof a==="number"&&a>=-1&&this.repeat(a-1,b);return this.play()},add:function(c,b){var d={},e=["setup","draw","teardown"],f,j=function(){return function(){}};if(c instanceof Function)d={setup:function(){},draw:c,teardown:function(){}};else if(c instanceof Object){c.draw instanceof Function||console&&console.error&&console.error("Trying to add an Object as an actor, but it does not have a draw function.");
for(f=0;f<e.length;f++)d[e[f]]=c[e[f]]instanceof Function?c[e[f]]:j()}else{console&&console.error&&console.error(c+" is not a valid actor Object.");return}d.params=b;d.constructor=c.draw;if(typeof d.id==="undefined")d.id=d.params.id||d.params.name||parseInt(Math.random().toString().substr(2),10)+ +new Date;delete d.params.name;if(typeof a._actorstateIndex[d.id]==="undefined")a._actorstateIndex[d.id]=[],a._actorstateIndex[d.id].queue=[],a._actorstateIndex[d.id].reachedKeyframes=[];a._actors[d.id]=
d;a._liveCopies[d.id]={};a._layerIndex.push(d.id);d.params.layer=a._layerIndex.length-1;d=P(d);d.setup(this);delete d.setup;return d},removeActor:function(c){var b,d,e;if(typeof c==="string"&&a._actors[c]){b=a._actors[c];d=a._actorstateIndex[c].slice(0);for(e=0;e<d.length;e++)b.remove(d[e]);delete a._actorstateIndex[c];delete a._currentState[c];for(e=0;e<a._layerIndex.length;e++)if(a._layerIndex[e]===c){a._layerIndex.splice(e,1);break}b=b.teardown;delete a._actors[c];b(c)}else console&&console.error&&
console.error(c," is not a valid actor ID.");return this},getActor:function(c){return a._actors[c]},getActorList:function(){var c=[],b;for(b in a._actors)a._actors.hasOwnProperty(b)&&c.push(b);return c},removeAllKeyframes:function(){for(var c in a._actors)a._actors.hasOwnProperty(c)&&a._actors[c].removeAll();return this},framerate:function(c){var b,d={},e={},f={},j,l,i,g;if(c&&typeof c==="number"&&c>0){b=a._params.fRate;b=c/b;a._params.fRate=parseInt(c,10);n(d,a._actorstateIndex);n(e,a._originalStates);
n(f,a._liveCopies);c=a._reachedKeyframes.slice(0);this.removeAllKeyframes();for(j in d)if(d.hasOwnProperty(j)){for(g=d[j].length-1;g>-1;g--)a._actors[j].keyframe(b*d[j][g],e[d[j][g]][j]);for(g=0;g<d[j].queue.length;g++)a._actorstateIndex[j].queue[g].duration*=b;a._actorstateIndex[j].reachedKeyframes=d[j].reachedKeyframes.splice(0)}for(i in f)if(f.hasOwnProperty(i))for(l in a._liveCopies[i]={},f[i])f[i].hasOwnProperty(l)&&a._actors[i].liveCopy(+l*b,f[i][l].copyOf);for(g=0;g<c.length;g++)a._reachedKeyframes[g]=
c[g]*b}return a._params.fRate},gotoFrame:function(c){var b=+new Date;this.isPlaying()&&this.stop();c=r(c)%a._lastKeyframe;a._currentFrame=c;a._loopStartTime=a._startTime=b-c*a._params.fRate;a._pausedAtTime=b;a._reachedKeyframes=a._keyframeIds.slice(0,q(a._keyframeIds));a.ctx.clearRect(0,0,a.el.width,a.el.height);M(a._currentFrame);return this},gotoAndPlay:function(a){this.gotoFrame(a);return this.play()},getNumberOfLayers:function(){return a._layerIndex.length},getState:function(){return a._currentState},
bind:function(c,b){typeof c==="string"&&typeof b==="function"&&(a._events[c]||(a._events[c]=[]),a._events[c].push(b));return this},unbind:function(c,b){var d;if(typeof c==="string"&&a._events[c])if(typeof b==="function")for(d=0;d<a._events[c].length;d++)a._events[c][d]===b&&a._events[c].splice(d,1);else a._events[c]=[];return this},_debug:function(){return a}};return C.init(w,x,y)}kapi.tween={linear:function(w,x,y,n){return y*w/n+x}};