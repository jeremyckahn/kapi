/**
 * Kapi - A keyframe API
 * v0.6.0
 * by Jeremy Kahn - jeremyckahn@gmail.com
 * hosted at: https://github.com/jeremyckahn/kapi
 * 
 * Kapi streamlines animation development for the HTML 5 canvas by providing a keyframing API.  It manages timing and tweening so you don't have to.   
 * 
 * Kapi is distributed under the MIT license.
 * Learn more about keyframes: http://en.wikipedia.org/wiki/Key_frame
 * 
 * Please use, distribute and enjoy.
 */

function kapi(p,q,r){function k(a,c,b){var d;if(!c)return a;a=a||{};for(d in c)if(c.hasOwnProperty(d))if(typeof c[d]==="object"&&d!=="prototype"){if(!a[d]||b)a[d]=E.call(c[d])==="[object Array]"?[]:{};k(a[d],c[d],b)}else if(typeof a[d]==="undefined"||b)a[d]=c[d];return k(a,void 0,b)}function v(a,c,b,d,e,f){if((f||this._currentFrame)>=c)return kapi.tween[a]((f||this._currentFrame)-c,d,e-d,b-c||1)}function n(a){return a.length>0?a[a.length-1]:undefined}function w(a){this[a]=this.style[a].replace(/px/gi,
"")||this._params[a]}function x(a){return a.sort(function(c,b){return c-b})}function y(a){return typeof a==="string"&&(/^#([0-9]|[a-f]){3}$/i.test(a)||/^#([0-9]|[a-f]){6}$/i.test(a))}function s(a){return typeof a==="string"&&/^rgb\(\d+\s*,\d+\s*,\d+\s*\)\s*$/i.test(a)}function t(a){return parseInt(a,16)}function z(a){if(typeof a==="string"){a=a.replace(/#/g,"");if(a.length===3)a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2];return[t(a.substr(0,2)),t(a.substr(2,2)),t(a.substr(4,2))]}else return[0,0,0]}function A(a){if(typeof a!==
"string")return a;if(/^(#|rgb)/.test(a))if(/^#/.test(a))return z(a);else{a=a.match(/\d+/g);return[+a[0],+a[1],+a[2]]}else return a}function u(a){return typeof a==="string"&&/^\s*(\+|\-|\*|\/)\=\d+\s*$/.test(a)}function B(a){return typeof a==="number"||typeof a==="function"||u(a)||y(a)||s(a)}var F={fRate:20,autoclear:true},E=Object.prototype.toString,C={ms:function(a){return a*this._params.fRate/1E3},s:function(a){return a*this._params.fRate}},D={"+=":function(a,c){return a+c},"-=":function(a,c){return a-
c},"*=":function(a,c){return a*c},"/=":function(a,c){return a/c}};return{init:function(a,c,b){var d,e;c=c||{};b=b||{};k(c,F);this._params=c;this.autoclear=!!this._params.autoclear;this.el=this._params.canvas=a;this.ctx=a.getContext("2d");this._events={};this._keyframeIds=[];this._reachedKeyframes=[];this._layerIndex=[];this._keyframes={};this._actors={};this._actorStateIndex={};this._keyframeCache={};this._originalStates={};this._liveCopies={};this._currentState={};this._animationDuration=0;this._repsRemaining=
-1;this.fCount=0;for(e in b)b.hasOwnProperty(e)&&this.bind(e,b[e]);for(d in this._params.styles)if(this._params.styles.hasOwnProperty(d)){this._params.styles[d]=this._params.styles[d].toString().toLowerCase();if(d==="height"||d==="width"||d==="top"||d==="left")this._params.styles[d].match(/px/)||(this._params.styles[d]+="px");a=this.el.style;c=d;b=this._params.styles[d];if(typeof b==="string")b=b.replace(/\s/g,"");a[c]=b}if(this._params.styles){this._params.styles.height&&w.call(this.el,"height");
this._params.styles.width&&w.call(this.el,"width")}delete this.init;return this},getVersion:function(){return"0.5.0"},isPlaying:function(){return this._isStopped===false&&this._isPaused===false},play:function(){var a;a=+new Date;if(this.isPlaying())return this;this._isStopped=this._isPaused=false;if(!this._startTime)this._startTime=a;if(this._loopStartTime){a-=this._pausedAtTime;this._loopStartTime+=a;this._startTime+=a}else{this._loopStartTime=a;this._updateAnimationDuration();this._fireEvent("loopStart")}this._updateState();
return this},pause:function(){clearTimeout(this._updateHandle);this._pausedAtTime=+new Date;this._isPaused=true;return this},stop:function(){var a;clearTimeout(this._updateHandle);delete this._loopStartTime;delete this._startTime;delete this._pausedAtTime;this._isStopped=true;this._repsRemaining=-1;for(a in this._actorStateIndex)if(this._actorStateIndex.hasOwnProperty(a)){this._actorStateIndex[a].queue=[];this._actorStateIndex[a].reachedKeyframes=[]}this.ctx.clearRect(0,0,this.el.width,this.el.height);
return this},repeat:function(a){this._repsRemaining=typeof a==="number"&&a>=-1?parseInt(a,10)+1:-1;return this.play()},iterate:function(a){typeof a==="number"&&a>=-1&&this.repeat(a-1);return this.play()},add:function(a,c){var b={},d=["setup","draw","teardown"],e,f=function(){return function(){}};if(a instanceof Function)b={setup:function(){},draw:a,teardown:function(){}};else if(a instanceof Object){a.draw instanceof Function||console&&console.error&&console.error("Trying to add an Object as an actor, but it does not have a draw function.");
for(e=0;e<d.length;e++)b[d[e]]=a[d[e]]instanceof Function?a[d[e]]:f()}else{console&&console.error&&console.error(a+" is not a valid actor Object.");return}b.params=c;b.constructor=a.draw;if(typeof b.id==="undefined")b.id=b.params.id||b.params.name||parseInt(Math.random().toString().substr(2),10)+ +new Date;delete b.params.name;if(typeof this._actorStateIndex[b.id]==="undefined"){this._actorStateIndex[b.id]=[];this._actorStateIndex[b.id].queue=[];this._actorStateIndex[b.id].reachedKeyframes=[]}this._actors[b.id]=
b;this._liveCopies[b.id]={};this._layerIndex.push(b.id);b.params.layer=this._layerIndex.length-1;b=this._addActorMethods(b);b.setup(this);delete b.setup;return b},removeActor:function(a){var c,b,d;if(typeof a==="string"&&this._actors[a]){c=this._actors[a];b=this._actorStateIndex[a].slice(0);for(d=0;d<b.length;d++)c.remove(b[d]);delete this._actorStateIndex[a];delete this._currentState[a];for(d=0;d<this._layerIndex.length;d++)if(this._layerIndex[d]===a){this._layerIndex.splice(d,1);break}c=c.teardown;
delete this._actors[a];c(a)}else console&&console.error&&console.error(a," is not a valid actor ID.");return this},getActor:function(a){return this._actors[a]},getActorList:function(){var a=[],c;for(c in this._actors)this._actors.hasOwnProperty(c)&&a.push(c);return a},removeAllKeyframes:function(){for(var a in this._actors)this._actors.hasOwnProperty(a)&&this._actors[a].removeAll();return this},framerate:function(a){var c,b={},d={},e={},f,h,i,g;if(a&&typeof a==="number"&&a>0){c=this._params.fRate;
c=a/c;this._params.fRate=parseInt(a,10);k(b,this._actorStateIndex);k(d,this._originalStates);k(e,this._liveCopies);a=this._reachedKeyframes.slice(0);this.removeAllKeyframes();for(f in b)if(b.hasOwnProperty(f)){for(g=b[f].length-1;g>-1;g--)this._actors[f].keyframe(c*b[f][g],d[b[f][g]][f]);for(g=0;g<b[f].queue.length;g++)this._actorStateIndex[f].queue[g].duration*=c;this._actorStateIndex[f].reachedKeyframes=b[f].reachedKeyframes.splice(0)}for(i in e)if(e.hasOwnProperty(i)){this._liveCopies[i]={};for(h in e[i])e[i].hasOwnProperty(h)&&
this._actors[i].liveCopy(+h*c,e[i][h].copyOf)}for(g=0;g<a.length;g++)this._reachedKeyframes[g]=a[g]*c}return this._params.fRate},gotoFrame:function(a){var c=+new Date;this.isPlaying()&&this.stop();this._currentFrame=a=this._getRealKeyframe(a)%this._lastKeyframe;this._loopStartTime=this._startTime=c-a*this._params.fRate;this._pausedAtTime=c;this._reachedKeyframes=this._keyframeIds.slice(0,this._getLatestKeyframeId(this._keyframeIds));this.ctx.clearRect(0,0,this.el.width,this.el.height);this._updateActors(this._currentFrame);
return this},gotoAndPlay:function(a){this.gotoFrame(a);return this.play()},getNumberOfLayers:function(){return this._layerIndex.length},getState:function(){return this._currentState},bind:function(a,c){if(typeof a==="string"&&typeof c==="function"){this._events[a]||(this._events[a]=[]);this._events[a].push(c)}return this},unbind:function(a,c){var b;if(typeof a==="string"&&this._events[a])if(typeof c==="function")for(b=0;b<this._events[a].length;b++)this._events[a][b]===c&&this._events[a].splice(b,
1);else this._events[a]=[];return this},_fireEvent:function(a){var c;if(typeof a==="string"&&this._events[a])for(c=0;c<this._events[a].length;c++)this._events[a][c].call(this)},_updateState:function(){var a=this,c=+new Date;this.fCount++;return this._updateHandle=setTimeout(function(){var b;a._loopLength=c-a._loopStartTime;if(a._loopLength>a._animationDuration&&a._reachedKeyframes.length===a._keyframeIds.length){a._hasHitValidFrame=false;a._loopStartTime=a._startTime+parseInt((c-a._startTime)/(a._animationDuration||
1),10)*a._animationDuration;a._loopLength-=a._animationDuration||a._loopLength;a._reachedKeyframes=[];a._keyframeCache={};a._fireEvent("loopComplete");if(a._repsRemaining>-1){a._repsRemaining--;if(a._repsRemaining===0){a.stop();a._repsRemaining=-1;return}}a._fireEvent("loopStart")}a._loopPosition=a._animationDuration?a._loopLength/a._animationDuration:0;a._currentFrame=parseInt(a._loopPosition*a._lastKeyframe,10);b=a._getLatestKeyframeId(a._keyframeIds);b=b===-1?a._lastKeyframe:a._keyframeIds[b];
if(b>(n(a._reachedKeyframes)||0))a._reachedKeyframes.push(b);b=a._reachedKeyframes.length?a._reachedKeyframes.length-1:0;if(a._reachedKeyframes[b]!==a._keyframeIds[b])a._currentFrame=a._reachedKeyframes[b]=a._keyframeIds[b];if(a._currentFrame<=a._lastKeyframe){a.autoclear!==false&&a.ctx.clearRect(0,0,a.el.width,a.el.height);a._fireEvent("enterFrame");a._updateActors(a._currentFrame)}a._updateState()},1E3/this._params.fRate)},_updateActors:function(a){var c,b,d,e,f,h,i;for(i=0;i<this._layerIndex.length;i++){c=
this._layerIndex[i];if(typeof this._actorStateIndex[c][0]!=="undefined"&&a>=this._actorStateIndex[c][0]){b=this._getActorState(c);if(b!==null){e=this._actorStateIndex[c].queue;if((f=e.length)>0){h=e[0];d=h.events;if(typeof d.start==="function"){d.start.call(this._actors[c]);delete d.start}if(h._internals.fromState===null)h._internals.fromState=b;d=this._getQueuedActionState(e,c);k(b,d,true);if(f!==e.length){e=this._getLatestKeyframeId(this._actorStateIndex[c]);this._keyframes[this._keyframeIds[e]][c]=
b}}b.prototype.draw.call(b,this.ctx)}}this._currentState[c]=b}},_getActorState:function(a){var c=this._actorStateIndex[a],b=this._getLatestKeyframeId(c),d,e,f,h;if(b===-1)return null;d=this._getNextKeyframeId(c,b);e=this._keyframes[c[b]][a];f=this._keyframes[c[d]][a];if(b===d&&this._lastKeyframe>0)return null;h=n(this._actorStateIndex[a].reachedKeyframes)||0;if(!this._keyframeCache[a]){this._keyframeCache[a]={from:{},to:{}};this._actorStateIndex[a].reachedKeyframes=[]}if(b!==h)if(b>h){this._actorStateIndex[a].reachedKeyframes.push(b);
this._keyframeCache[a]={from:this._keyframeCache[a].to,to:{}}}return this._calculateCurrentFrameProps(e,f,c[b],c[d],f.easing)},_getQueuedActionState:function(a,c){var b=+new Date,d=a[0],e=d._internals;if(e.startTime===null)e.startTime=b;if(!e.pauseBufferUpdated)e.pauseBufferUpdated=b;if(e.pauseBufferUpdated<this._pausedAtTime){e.pauseBuffer+=b-this._pausedAtTime;e.pauseBufferUpdated=b}if(e.toState===null){e.toState={};k(e.toState,e.fromState);k(e.toState,d.state,true)}e.currFrame=e.forceStop?d.duration+
1:(b-(e.startTime+e.pauseBuffer))/1E3*this._params.fRate;if(e.currFrame>d.duration){b=d.events.complete;typeof b==="function"&&b.call(this._actors[c]);a.shift()}return this._calculateCurrentFrameProps(e.fromState,e.toState,0,+d.duration,d.easing||e.fromState.easing,{currentFrame:e.currFrame})},_calculateCurrentFrameProps:function(a,c,b,d,e,f){var h,i,g,j,l,o,m={};e=kapi.tween[e]?e:"linear";f=f||{};for(i in a)if(a.hasOwnProperty(i)){g=a[i];j=a.prototype.id;if(typeof this._keyframeCache[j].from[i]!==
"undefined")g=this._keyframeCache[j].from[i];else if(typeof g==="function"||u(g)){if(typeof g==="function")g=g.call(a)||0;else{h=g.match(/(\+|\-|\*|\/)\=/)[0];l=this._getPreviousKeyframeId(this._actorStateIndex[j]);l=l===-1?a.prototype.params[i]||0:this._keyframes[l][j][i];g=D[h](l,+g.replace(/\D/g,""))}this._keyframeCache[j].from[i]=g}if(B(g)){l=false;j=c[i];o=c.prototype.id;if(typeof this._keyframeCache[o].to[i]!=="undefined")j=this._keyframeCache[o].to[i];else if(typeof j==="function"||u(j)){if(typeof j===
"function")j=j.call(c)||0;else{h=j.match(/(\+|\-|\*|\/)\=/)[0];j=D[h](g,+j.replace(/\D/g,""))}this._keyframeCache[o].to[i]=j}h=typeof g;if(!B(j)||h!==typeof j)m[i]=g;else{if(typeof g==="string"){l=true;g=A(g);j=A(j)}if(l){m[i]="rgb(";for(h=0;h<g.length;h++)m[i]+=Math.floor(v.call(this,e,b,d,g[h],j[h],f.currentFrame))+",";m[i]=m[i].replace(/,$/,")")}else m[i]=v.call(this,e,b,d,g,j,f.currentFrame)}}}k(m,a);return m},_getPreviousKeyframeId:function(a){return this._getLatestKeyframeId(a)-1},_getLatestKeyframeId:function(a){var c;
if(this._currentFrame===0)return 0;if(this._currentFrame>a[a.length-1])return-1;for(c=a.length-1;c>=0;c--)if(a[c]<this._currentFrame)return c;return a.length-1},_getNextKeyframeId:function(a,c){return c===a.length-1?c:c+1},_addActorMethods:function(a){var c=this;a.keyframe=function(b,d){var e,f;for(e in d)if(d.hasOwnProperty(e))if(typeof d[e]==="string"&&d[e]===(f=+d[e].replace(/\D/gi,"")).toString())d[e]=f;e=k({},d);try{b=c._getRealKeyframe(b)}catch(h){window.console&&window.console.error&&console.error(h);
return}if(b<0)throw"Keyframe "+b+" is less than zero!";if(b>0&&typeof c._keyframes["0"]==="undefined"){c._keyframes["0"]={};c._keyframeIds.unshift(0)}if(typeof c._keyframes[b]==="undefined")c._keyframes[b]={};if(typeof c._originalStates[b]==="undefined")c._originalStates[b]={};c._keyframes[b][a.id]=d;c._originalStates[b][a.id]=e;c._updateKeyframes(a,b);delete d.layer;c._updateAnimationDuration();return this};a.to=function(b,d,e){var f=c._actorStateIndex[a.id].queue;f.push({duration:c._getRealKeyframe(b),
state:d||{},events:e||{}});b=n(f);b._internals={};b._internals.startTime=null;b._internals.fromState=null;b._internals.toState=null;b._internals.pauseBuffer=null;b._internals.pauseBufferUpdated=null;return this};a.clearQueue=function(){c._actorStateIndex[a.id].queue.length=1;return this};a.skipToEnd=function(){var b=c._actorStateIndex[a.id].queue;if(!b.length)return this;b[0]._internals.forceStop=true;return this};a.endCurrentAction=function(){var b=c._actorStateIndex[a.id].queue;if(!b.length)return this;
b[0]._internals.toState=this.getState();this.skipToEnd();return this};a.remove=function(b){var d,e,f,h=false;b=c._getRealKeyframe(b);if(c._keyframes[b]&&c._keyframes[b][a.id]){delete c._keyframes[b][a.id];delete c._originalStates[b][a.id];for(d in c._keyframes[b])if(c._keyframes[b].hasOwnProperty(d))h=true;if(!h&&b!==0){delete c._keyframes[b];delete c._originalStates[b];for(d=0;d<c._keyframeIds.length;d++)if(c._keyframeIds[d]===b){c._keyframeIds.splice(d,1);break}for(d=0;d<c._reachedKeyframes.length;d++)if(c._reachedKeyframes[d]===
b){c._reachedKeyframes.splice(d,1);break}}for(d=0;d<c._actorStateIndex[a.id].length;d++)if(c._actorStateIndex[a.id][d]===b){c._actorStateIndex[a.id].splice(d,1);d<=c._actorStateIndex[a.id].reachedKeyframes.length&&c._actorStateIndex[a.id].reachedKeyframes.pop();break}b in c._liveCopies&&delete c._liveCopies[a.id][b];for(e in c._liveCopies[a.id])if(c._liveCopies[a.id].hasOwnProperty(e)&&c._liveCopies[a.id][e].copyOf===b){a.remove(e);f=true}f||delete c._liveCopies[a.id];c._updateAnimationDuration()}else if(console&&
console.error)c._keyframes[b]?console.error("Trying to remove "+a.id+" from keyframe "+b+", but "+a.id+" does not exist at that keyframe."):console.error("Trying to remove "+a.id+" from keyframe "+b+", but keyframe "+b+" does not exist.");return this};a.removeAll=function(){for(var b=a.id;c._actorStateIndex[b]&&c._actorStateIndex[b].length;)c._actors[b].remove(n(c._actorStateIndex[b]));return this};a.updateKeyframe=function(b,d){var e;b=c._getRealKeyframe(b);if(c._keyframes[b]&&c._keyframes[b][a.id]){e=
c._originalStates[b][a.id];k(e,d,true);a.keyframe(b,e)}else if(window.console&&window.console.error)c._keyframes[b]?console.error("Keyframe "+b+" does not contain "+a.id):console.error("Keyframe "+b+" does not exist.");return this};a.liveCopy=function(b,d){b=c._getRealKeyframe(b);d=c._getRealKeyframe(d);if(c._keyframes[d]&&c._keyframes[d][a.id]){c._liveCopies[a.id][b]={copyOf:d};a.keyframe(b,{})}else if(window.console&&window.console.error)c._keyframes[d]?console.error("Trying to make a liveCopy of "+
d+", but  "+a.id+" does not exist at keyframe "+b+"."):console.error("Trying to make a liveCopy of "+d+", but keyframe "+d+" does not exist.");return this};a.getState=function(){return c._currentState[a.id]||{}};a.get=function(b){return b.toLowerCase()==="layer"?c._actors[a.id].params.layer:a.getState()[b]};a.moveToLayer=function(b){var d;if(typeof b!=="number")throw"moveToLayer requires a number specifying which layer to move "+this.id+" to.";b=parseInt(b,10);if(b>-1&&b<c._layerIndex.length){d=c._layerIndex.splice(a.params.layer,
1)[0];c._layerIndex.splice(b,0,d);c._updateLayers()}else throw'"'+b+'" is out of bounds.  There are only '+c._layerIndex.length+" layers in the animation, "+a.id+" can only be moved to layers 0-"+c._layerIndex.length;return a};return a},_getRealKeyframe:function(a){var c;if(typeof a==="number")return parseInt(a,10);else if(typeof a==="string"){a=a.replace(/\s/g,"");c=/^(\d|\.)+/.exec(a)[0];a=/\D+$/.exec(a);if(!a)return parseInt(c,10);if(C[a])c=parseInt(C[a].call(this,c),10);else throw"Invalid keyframe identifier unit!";
return c}else throw"Invalid keyframe identifier type!";},_updateKeyframes:function(a,c){this._updateKeyframeIdsList(c);this._updateActorStateIndex(a,{add:c});this._normalizeActorAcrossKeyframes(a.id);this._updateLiveCopies();this._updateLayers()},_updateKeyframeIdsList:function(a){var c;for(c=0;c<this._keyframeIds.length;c++)if(this._keyframeIds[c]===a)return;this._keyframeIds.push(a);x(this._keyframeIds)},_normalizeActorAcrossKeyframes:function(a){var c,b,d,e,f,h;for(h=0;h<this._actorStateIndex[a].length;h++){c=
this._actorStateIndex[a][h];d=typeof b==="undefined"?k({},this._actors[a].params):k({},d);d=k(d,this._originalStates[c][a],true);d.prototype=this._actors[a];this._keyframes[c][a]=d;for(e in d)if(d.hasOwnProperty(e)&&typeof d[e]==="string"){f=d[e].replace(/\s/g,"");if(y(f)||s(f)){b=d;var i=e;var g=void 0;if(!s(f)){g=z(f);f="rgb("+g[0]+","+g[1]+","+g[2]+")"}b[i]=f}}b=c}},_updateActorStateIndex:function(a,c){var b=this._actorStateIndex[a.id],d=false,e;if(typeof c.add!=="undefined"){for(e=0;e<b.length;e++)if(b[e]===
c.add)d=true;if(!d){b.push(c.add);x(b)}}},_updateLayers:function(){var a;for(a=0;a<this._layerIndex.length;a++)this._actors[this._layerIndex[a]].params.layer=a},_updateLiveCopies:function(){var a,c,b;for(c in this._liveCopies)if(this._liveCopies.hasOwnProperty(c)){b=this._liveCopies[c];for(a in b)if(b.hasOwnProperty(a))this._keyframes[a][c]=this._keyframes[this._liveCopies[c][a].copyOf][c]}},_updateAnimationDuration:function(){this._lastKeyframe=n(this._keyframeIds);this._animationDuration=1E3*(this._lastKeyframe/
this._params.fRate)}}.init(p,q,r)}kapi.tween={linear:function(p,q,r,k){return r*p/k+q}};
