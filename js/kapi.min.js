/**
 * Kapi - A keyframe API
 * v0.2.1
 * by Jeremy Kahn - jeremyckahn@gmail.com
 * hosted at: https://github.com/jeremyckahn/kapi
 * 
 * Kapi streamlines animation development for the HTML 5 canvas by providing a keyframing API.  It manages timing and tweening so you don't have to.   
 * 
 * Kapi is distributed under the MIT license.
 * Learn more about keyframes: http://en.wikipedia.org/wiki/Key_frame
 * 
 * Please use, distribute and enjoy.
 */

function kapi(p,q,r){function k(a,b,c){var d;if(!b)return a;a=a||{};for(d in b)if(b.hasOwnProperty(d))if(typeof b[d]==="object"&&d!=="prototype"){if(!a[d]||c)a[d]=E.call(b[d])==="[object Array]"?[]:{};k(a[d],b[d],c)}else if(typeof a[d]==="undefined"||c)a[d]=b[d];return k(a,void 0,c)}function v(a,b,c,d,e,f){if((f||this._currentFrame)>=b)return kapi.tween[a]((f||this._currentFrame)-b,d,e-d,c-b||1)}function n(a){return a.length>0?a[a.length-1]:undefined}function w(a){this[a]=this.style[a].replace(/px/gi,
"")||this._params[a]}function x(a){return a.sort(function(b,c){return b-c})}function y(a){return typeof a==="string"&&(/^#([0-9]|[a-f]){3}$/i.test(a)||/^#([0-9]|[a-f]){6}$/i.test(a))}function s(a){return typeof a==="string"&&/^rgb\(\d+\s*,\d+\s*,\d+\s*\)\s*$/i.test(a)}function t(a){return parseInt(a,16)}function z(a){if(typeof a==="string"){a=a.replace(/#/g,"");if(a.length===3)a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2];return[t(a.substr(0,2)),t(a.substr(2,2)),t(a.substr(4,2))]}else return[0,0,0]}function A(a){if(typeof a!==
"string")return a;if(/^(#|rgb)/.test(a))if(/^#/.test(a))return z(a);else{a=a.match(/\d+/g);return[+a[0],+a[1],+a[2]]}else return a}function u(a){return typeof a==="string"&&/^\s*(\+|\-|\*|\/)\=\d+\s*$/.test(a)}function B(a){return typeof a==="number"||typeof a==="function"||u(a)||y(a)||s(a)}var F={fRate:20,autoclear:true},E=Object.prototype.toString,C={ms:function(a){return a*this._params.fRate/1E3},s:function(a){return a*this._params.fRate}},D={"+=":function(a,b){return a+b},"-=":function(a,b){return a-
b},"*=":function(a,b){return a*b},"/=":function(a,b){return a/b}};return{init:function(a,b,c){var d;b=b||{};c=c||{};k(b,F);this._params=b;this.autoclear=!!this._params.autoclear;this._params.canvas=a;this.events=c;this.el=a;this.ctx=a.getContext("2d");this._keyframeIds=[];this._reachedKeyframes=[];this._layerIndex=[];this._keyframes={};this._actors={};this._actorStateIndex={};this._keyframeCache={};this._originalStates={};this._liveCopies={};this._currentState={};this.fCount=this._animationDuration=
0;for(d in this._params.styles)if(this._params.styles.hasOwnProperty(d)){this._params.styles[d]=this._params.styles[d].toString().toLowerCase();if(d==="height"||d==="width"||d==="top"||d==="left")this._params.styles[d].match(/px/)||(this._params.styles[d]+="px");a=this.el.style;b=d;c=this._params.styles[d];if(typeof c==="string")c=c.replace(/\s/g,"");a[b]=c}if(this._params.styles){this._params.styles.height&&w.call(this.el,"height");this._params.styles.width&&w.call(this.el,"width")}delete this.init;
return this},getVersion:function(){return"0.2.2"},isPlaying:function(){return this._isStopped===false&&this._isPaused===false},play:function(){var a;a=+new Date;if(!this.isPlaying()){this._isStopped=this._isPaused=false;if(!this._startTime)this._startTime=a;if(this._loopStartTime){a=a-this._pausedAtTime;this._loopStartTime+=a;this._startTime+=a}else this._loopStartTime=a;this._updateState();return this}},pause:function(){clearTimeout(this._updateHandle);this._pausedAtTime=+new Date;this._isPaused=
true;return this},stop:function(){var a;clearTimeout(this._updateHandle);delete this._loopStartTime;delete this._pausedAtTime;this._isStopped=true;for(a in this._actorStateIndex)if(this._actorStateIndex.hasOwnProperty(a))this._actorStateIndex[a].queue=[];this.ctx.clearRect(0,0,this.el.width,this.el.height);return this},add:function(a,b){var c={},d=["setup","draw","teardown"],e,f=function(){return function(){}};if(a instanceof Function)c={setup:function(){},draw:a,teardown:function(){}};else if(a instanceof
Object){a.draw instanceof Function||console&&console.error&&console.error("Trying to add an Object as an actor, but it does not have a draw function.");for(e=0;e<d.length;e++)c[d[e]]=a[d[e]]instanceof Function?a[d[e]]:f()}else{console&&console.error&&console.error(a+" is not a valid actor Object.");return}c.params=b;c.constructor=a.draw;if(typeof c.id==="undefined")c.id=c.params.id||c.params.name||parseInt(Math.random().toString().substr(2),10)+ +new Date;delete c.params.name;if(typeof this._actorStateIndex[c.id]===
"undefined"){this._actorStateIndex[c.id]=[];this._actorStateIndex[c.id].queue=[];this._actorStateIndex[c.id].reachedKeyframes=[]}this._actors[c.id]=c;this._liveCopies[c.id]={};this._layerIndex.push(c.id);c.params.layer=this._layerIndex.length-1;c=this._addActorMethods(c);c.setup(this);delete c.setup;return c},getActor:function(a){return this._actors[a]},getActorList:function(){var a=[],b;for(b in this._actors)this._actors.hasOwnProperty(b)&&a.push(b);return a},removeAllKeyframes:function(){for(var a in this._actorStateIndex)if(this._actorStateIndex.hasOwnProperty(a))for(;this._actorStateIndex[a]&&
this._actorStateIndex[a].length;)this._actors[a].remove(n(this._actorStateIndex[a]));return this},framerate:function(a){var b,c={},d={},e={},f,h,i,g;if(a&&typeof a==="number"&&a>0){b=this._params.fRate;b=a/b;this._params.fRate=parseInt(a,10);k(c,this._actorStateIndex);k(d,this._originalStates);k(e,this._liveCopies);a=this._reachedKeyframes.slice(0);this.removeAllKeyframes();for(f in c)if(c.hasOwnProperty(f)){for(g=c[f].length-1;g>-1;g--)this._actors[f].keyframe(b*c[f][g],d[c[f][g]][f]);for(g=0;g<
c[f].queue.length;g++)this._actorStateIndex[f].queue[g].duration*=b;this._actorStateIndex[f].reachedKeyframes=c[f].reachedKeyframes.splice(0)}for(i in e)if(e.hasOwnProperty(i)){this._liveCopies[i]={};for(h in e[i])e[i].hasOwnProperty(h)&&this._actors[i].liveCopy(+h*b,e[i][h].copyOf)}for(g=0;g<a.length;g++)this._reachedKeyframes[g]=a[g]*b}return this._params.fRate},gotoFrame:function(a){var b=+new Date;this.isPlaying()&&this.stop();this._currentFrame=a=this._getRealKeyframe(a)%this._lastKeyframe;this._loopStartTime=
this._startTime=b-a*this._params.fRate;this._pausedAtTime=b;this._reachedKeyframes=this._keyframeIds.slice(0,this._getLatestKeyframeId(this._keyframeIds));this.ctx.clearRect(0,0,this.el.width,this.el.height);this._updateActors(this._currentFrame);return this},gotoAndPlay:function(a){this.gotoFrame(a);return this.play()},getNumberOfLayers:function(){return this._layerIndex.length},getState:function(){return this._currentState},_updateState:function(){var a=this,b=+new Date;this.fCount++;return this._updateHandle=
setTimeout(function(){var c;a._loopLength=b-a._loopStartTime;if(a._loopLength>a._animationDuration&&a._reachedKeyframes.length===a._keyframeIds.length){a._hasHitValidFrame=false;a._loopStartTime=a._startTime+parseInt((b-a._startTime)/(a._animationDuration||1),10)*a._animationDuration;a._loopLength-=a._animationDuration||a._loopLength;a._reachedKeyframes=[];a._keyframeCache={}}a._loopPosition=a._animationDuration?a._loopLength/a._animationDuration:0;a._currentFrame=parseInt(a._loopPosition*a._lastKeyframe,
10);c=a._getLatestKeyframeId(a._keyframeIds);c=c===-1?a._lastKeyframe:a._keyframeIds[c];if(c>(n(a._reachedKeyframes)||0))a._reachedKeyframes.push(c);c=a._reachedKeyframes.length?a._reachedKeyframes.length-1:0;if(a._reachedKeyframes[c]!==a._keyframeIds[c])a._currentFrame=a._reachedKeyframes[c]=a._keyframeIds[c];if(a._currentFrame<=a._lastKeyframe){a.autoclear!==false&&a.ctx.clearRect(0,0,a.el.width,a.el.height);typeof a.events.enterFrame==="function"&&a.events.enterFrame.call(a);a._updateActors(a._currentFrame)}a._updateState()},
1E3/this._params.fRate)},_updateActors:function(a){var b,c,d,e,f,h;for(h=0;h<this._layerIndex.length;h++){b=this._layerIndex[h];if(typeof this._actorStateIndex[b][0]!=="undefined"&&a>=this._actorStateIndex[b][0]){c=this._getActorState(b);if(c!==null){e=this._actorStateIndex[b].queue;if((f=e.length)>0){if(e[0]._internals.fromState===null)e[0]._internals.fromState=c;d=this._getQueuedActionState(e);k(c,d,true);if(f!==e.length){d=this._getLatestKeyframeId(this._actorStateIndex[b]);this._keyframes[this._keyframeIds[d]][b]=
c}}c.prototype.draw.call(c,this.ctx)}}this._currentState[b]=c}},_getActorState:function(a){var b=this._actorStateIndex[a],c=this._getLatestKeyframeId(b),d,e,f,h;if(c===-1)return null;d=this._getNextKeyframeId(b,c);e=this._keyframes[b[c]][a];f=this._keyframes[b[d]][a];if(c===d&&this._lastKeyframe>0)return null;h=n(this._actorStateIndex[a].reachedKeyframes)||0;if(!this._keyframeCache[a]){this._keyframeCache[a]={from:{},to:{}};this._actorStateIndex[a].reachedKeyframes=[]}if(c!==h)if(c>h){this._actorStateIndex[a].reachedKeyframes.push(c);
this._keyframeCache[a]={from:this._keyframeCache[a].to,to:{}}}return this._calculateCurrentFrameProps(e,f,b[c],b[d],f.easing)},_getQueuedActionState:function(a){var b=+new Date,c=a[0],d=c._internals;if(d.startTime===null)d.startTime=b;if(!d.pauseBufferUpdated)d.pauseBufferUpdated=b;if(d.pauseBufferUpdated<this._pausedAtTime){d.pauseBuffer+=b-this._pausedAtTime;d.pauseBufferUpdated=b}if(d.toState===null){d.toState={};k(d.toState,d.fromState);k(d.toState,c.state,true)}d.currFrame=(b-(d.startTime+d.pauseBuffer))/
1E3*this._params.fRate;d.currFrame>c.duration&&a.shift();return this._calculateCurrentFrameProps(d.fromState,d.toState,0,+c.duration,c.easing||d.fromState.easing,{currentFrame:d.currFrame})},_calculateCurrentFrameProps:function(a,b,c,d,e,f){var h,i,g,j,l,o,m={};e=kapi.tween[e]?e:"linear";f=f||{};for(i in a)if(a.hasOwnProperty(i)){g=a[i];j=a.prototype.id;if(typeof this._keyframeCache[j].from[i]!=="undefined")g=this._keyframeCache[j].from[i];else if(typeof g==="function"||u(g)){if(typeof g==="function")g=
g.call(a)||0;else{h=g.match(/(\+|\-|\*|\/)\=/)[0];l=this._getPreviousKeyframeId(this._actorStateIndex[j]);l=l===-1?a.prototype.params[i]||0:this._keyframes[l][j][i];g=D[h](l,+g.replace(/\D/g,""))}this._keyframeCache[j].from[i]=g}if(B(g)){l=false;j=b[i];o=b.prototype.id;if(typeof this._keyframeCache[o].to[i]!=="undefined")j=this._keyframeCache[o].to[i];else if(typeof j==="function"||u(j)){if(typeof j==="function")j=j.call(b)||0;else{h=j.match(/(\+|\-|\*|\/)\=/)[0];j=D[h](g,+j.replace(/\D/g,""))}this._keyframeCache[o].to[i]=
j}h=typeof g;if(!B(j)||h!==typeof j)m[i]=g;else{if(typeof g==="string"){l=true;g=A(g);j=A(j)}if(l){m[i]="rgb(";for(h=0;h<g.length;h++)m[i]+=Math.floor(v.call(this,e,c,d,g[h],j[h],f.currentFrame))+",";m[i]=m[i].replace(/,$/,")")}else m[i]=v.call(this,e,c,d,g,j,f.currentFrame)}}}k(m,a);return m},_getPreviousKeyframeId:function(a){return this._getLatestKeyframeId(a)-1},_getLatestKeyframeId:function(a){var b;if(this._currentFrame===0)return 0;if(this._currentFrame>a[a.length-1])return-1;for(b=a.length-
1;b>=0;b--)if(a[b]<this._currentFrame)return b;return a.length-1},_getNextKeyframeId:function(a,b){return b===a.length-1?b:b+1},_addActorMethods:function(a){var b=this;a.keyframe=function(c,d){var e,f;for(e in d)if(d.hasOwnProperty(e))if(typeof d[e]==="string"&&d[e]===(f=+d[e].replace(/\D/gi,"")).toString())d[e]=f;e=k({},d);try{c=b._getRealKeyframe(c)}catch(h){window.console&&window.console.error&&console.error(h);return}if(c<0)throw"Keyframe "+c+" is less than zero!";if(c>0&&typeof b._keyframes["0"]===
"undefined"){b._keyframes["0"]={};b._keyframeIds.unshift(0)}if(typeof b._keyframes[c]==="undefined")b._keyframes[c]={};if(typeof b._originalStates[c]==="undefined")b._originalStates[c]={};b._keyframes[c][a.id]=d;b._originalStates[c][a.id]=e;b._updateKeyframes(a,c);delete d.layer;b._updateAnimationDuration();return this};a.to=function(c,d){var e;e=b._actorStateIndex[a.id].queue;e.push({duration:b._getRealKeyframe(c),state:d});e=n(e);e._internals={};e._internals.startTime=null;e._internals.fromState=
null;e._internals.toState=null;e._internals.pauseBuffer=null;e._internals.pauseBufferUpdated=null;return this};a.remove=function(c){var d,e,f,h=false;c=b._getRealKeyframe(c);if(b._keyframes[c]&&b._keyframes[c][a.id]){delete b._keyframes[c][a.id];delete b._originalStates[c][a.id];for(d in b._keyframes[c])if(b._keyframes[c].hasOwnProperty(d))h=true;if(!h&&c!==0){delete b._keyframes[c];delete b._originalStates[c];for(d=0;d<b._keyframeIds.length;d++)if(b._keyframeIds[d]===c){b._keyframeIds.splice(d,1);
break}for(d=0;d<b._reachedKeyframes.length;d++)if(b._reachedKeyframes[d]===c){b._reachedKeyframes.splice(d,1);break}}for(d=0;d<b._actorStateIndex[a.id].length;d++)if(b._actorStateIndex[a.id][d]===c){b._actorStateIndex[a.id].splice(d,1);d<=b._actorStateIndex[a.id].reachedKeyframes.length&&b._actorStateIndex[a.id].reachedKeyframes.pop();break}c in b._liveCopies&&delete b._liveCopies[a.id][c];for(e in b._liveCopies[a.id])if(b._liveCopies[a.id].hasOwnProperty(e)&&b._liveCopies[a.id][e].copyOf===c){a.remove(e);
f=true}f||delete b._liveCopies[a.id];b._updateAnimationDuration()}else if(console&&console.error)b._keyframes[c]?console.error("Trying to remove "+a.id+" from keyframe "+c+", but "+a.id+" does not exist at that keyframe."):console.error("Trying to remove "+a.id+" from keyframe "+c+", but keyframe "+c+" does not exist.");return this};a.updateKeyframe=function(c,d){var e;c=b._getRealKeyframe(c);if(b._keyframes[c]&&b._keyframes[c][a.id]){e=b._originalStates[c][a.id];k(e,d,true);a.keyframe(c,e)}else if(window.console&&
window.console.error)b._keyframes[c]?console.error("Keyframe "+c+" does not contain "+a.id):console.error("Keyframe "+c+" does not exist.");return this};a.liveCopy=function(c,d){c=b._getRealKeyframe(c);d=b._getRealKeyframe(d);if(b._keyframes[d]&&b._keyframes[d][a.id]){b._liveCopies[a.id][c]={copyOf:d};a.keyframe(c,{})}else if(window.console&&window.console.error)b._keyframes[d]?console.error("Trying to make a liveCopy of "+d+", but  "+a.id+" does not exist at keyframe "+c+"."):console.error("Trying to make a liveCopy of "+
d+", but keyframe "+d+" does not exist.");return this};a.getState=function(){return b._currentState[a.id]||{}};a.get=function(c){return c.toLowerCase()==="layer"?b._actors[a.id].params.layer:a.getState()[c]};a.moveToLayer=function(c){var d;if(typeof c!=="number")throw"moveToLayer requires a number specifying which layer to move "+this.id+" to.";c=parseInt(c,10);if(c>-1&&c<b._layerIndex.length){d=b._layerIndex.splice(a.params.layer,1)[0];b._layerIndex.splice(c,0,d);b._updateLayers()}else throw'"'+
c+'" is out of bounds.  There are only '+b._layerIndex.length+" layers in the animation, "+a.id+" can only be moved to layers 0-"+b._layerIndex.length;return a};return a},_getRealKeyframe:function(a){var b;if(typeof a==="number")return parseInt(a,10);else if(typeof a==="string"){a=a.replace(/\s/g,"");b=/^(\d|\.)+/.exec(a)[0];a=/\D+$/.exec(a);if(!a)return parseInt(b,10);if(C[a])b=parseInt(C[a].call(this,b),10);else throw"Invalid keyframe identifier unit!";return b}else throw"Invalid keyframe identifier type!";
},_updateKeyframes:function(a,b){this._updateKeyframeIdsList(b);this._updateActorStateIndex(a,{add:b});this._normalizeActorAcrossKeyframes(a.id);this._updateLiveCopies();this._updateLayers()},_updateKeyframeIdsList:function(a){var b;for(b=0;b<this._keyframeIds.length;b++)if(this._keyframeIds[b]===a)return;this._keyframeIds.push(a);x(this._keyframeIds)},_normalizeActorAcrossKeyframes:function(a){var b,c,d,e,f,h;for(h=0;h<this._actorStateIndex[a].length;h++){b=this._actorStateIndex[a][h];d=typeof c===
"undefined"?k({},this._actors[a].params):k({},d);d=k(d,this._originalStates[b][a],true);d.prototype=this._actors[a];this._keyframes[b][a]=d;for(e in d)if(d.hasOwnProperty(e)&&typeof d[e]==="string"){f=d[e].replace(/\s/g,"");if(y(f)||s(f)){c=d;var i=e;f=f;var g=void 0;if(s(f))f=f;else{g=z(f);f="rgb("+g[0]+","+g[1]+","+g[2]+")"}c[i]=f}}c=b;d=d}},_updateActorStateIndex:function(a,b){var c=this._actorStateIndex[a.id],d=false,e;if(typeof b.add!=="undefined"){for(e=0;e<c.length;e++)if(c[e]===b.add)d=true;
if(!d){c.push(b.add);x(c)}}},_updateLayers:function(){var a;for(a=0;a<this._layerIndex.length;a++)this._actors[this._layerIndex[a]].params.layer=a},_updateLiveCopies:function(){var a,b,c;for(b in this._liveCopies)if(this._liveCopies.hasOwnProperty(b)){c=this._liveCopies[b];for(a in c)if(c.hasOwnProperty(a))this._keyframes[a][b]=this._keyframes[this._liveCopies[b][a].copyOf][b]}},_updateAnimationDuration:function(){this._lastKeyframe=n(this._keyframeIds);this._animationDuration=1E3*(this._lastKeyframe/
this._params.fRate)}}.init(p,q,r)}kapi.tween={linear:function(p,q,r,k){return r*p/k+q}};